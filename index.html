<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1학년 1반</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    .popup {
      position: absolute;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 1rem;
      z-index: 9999;
      display: none;
      max-width: 160px;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      #periodTabs button {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen p-4">
  <div class="flex justify-between items-center max-w-screen-md mx-auto mb-4">
    <h1 class="text-xl font-bold text-slate-800">1학년 1반</h1>
    <div class="flex gap-2 items-center">
      <input type="date" id="datePicker" class="border rounded px-2 py-1 text-sm shadow-sm" />
      <select id="subjectSelect" class="border rounded px-2 py-1 text-sm shadow-sm">
        <option>국어</option><option>수학</option><option>통합</option><option>활동</option><option>기타</option>
      </select>
      <button id="saveOrderBtn" class="border text-xs px-2 py-1 rounded shadow-sm text-gray-600 bg-white">자리 저장</button>
    </div>
  </div>
  <div class="flex justify-center mb-4 gap-1 flex-wrap text-xs sm:text-sm" id="periodTabs">
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="1교시">1교시</button>
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="2교시">2교시</button>
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="3교시">3교시</button>
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="4교시">4교시</button>
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="5교시">5교시</button>
    <button class="period-btn px-3 py-1 rounded-md font-medium shadow-sm transition bg-white text-gray-700 border" data-period="전체">전체</button>
  </div>
  <div id="studentGrid" class="grid grid-cols-5 gap-3 max-w-screen-md mx-auto"></div>
  <div id="popup" class="popup"></div>
  
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>

  <script>
    let students = [];
    let currentPeriod = "1교시";
    let dragIndex = null;

    function getTodayDate() {
      return datePicker.value || new Date().toISOString().split("T")[0];
    }

    function getStudentOrderHistory() {
      return JSON.parse(localStorage.getItem("student_order_history") || "[]");
    }

    function setStudentOrderHistory(history) {
      localStorage.setItem("student_order_history", JSON.stringify(history));
    }

    function loadStudents() {
      const today = getTodayDate();
      const history = getStudentOrderHistory();
      const applicable = history.filter(h => h.date <= today).pop();
      if (applicable) {
        students = applicable.order;
      } else {
        students = [
          "김지애", "박지효", "배라은", "이해나", "임재인",
          "정나예", "최이쁨", "한지윤", "김유온", "김주빈",
          "김채우", "나하성", "명승주", "박채민", "신채담",
          "최서빈", "최여울", "하로아"
        ];
      }
    }

    function saveStudentOrderForToday() {
      const today = getTodayDate();
      let history = getStudentOrderHistory();
      history = history.filter(h => h.date !== today);
      history.push({ date: today, order: students });
      history.sort((a, b) => new Date(a.date) - new Date(b.date));
      setStudentOrderHistory(history);
    }

    function getStorageKey(date, period) {
      return `scores_${date}_${period}`;
    }

    function loadScores() {
      const data = localStorage.getItem(getStorageKey(getTodayDate(), currentPeriod));
      return data ? JSON.parse(data) : students.map(() => ({ 발표: 0, 경청: 0, 지도: 0 }));
    }

    function saveScores(scores) {
      localStorage.setItem(getStorageKey(getTodayDate(), currentPeriod), JSON.stringify(scores));
    }

    function loadTotalScores() {
      return students.map((_, i) => {
        let total = { 발표: 0, 경청: 0, 지도: 0 };
        ["1교시", "2교시", "3교시", "4교시", "5교시"].forEach(p => {
          const key = getStorageKey(getTodayDate(), p);
          const scores = JSON.parse(localStorage.getItem(key)) || students.map(() => ({ 발표: 0, 경청: 0, 지도: 0 }));
          total.발표 += scores[i].발표;
          total.경청 += scores[i].경청;
          total.지도 += scores[i].지도;
        });
        return total;
      });
    }

    function openPopup(index, e) {
      e.stopPropagation();
      const rect = e.target.getBoundingClientRect();
      popup.style.top = rect.bottom + window.scrollY + "px";
      popup.style.left = rect.left + window.scrollX + "px";
      popup.style.display = "block";
      popup.innerHTML = `
        <h2 class="font-bold text-gray-800 mb-1 text-center truncate">${students[index]}</h2>
        <div class="flex gap-2 justify-center">
          <button onclick="addScore(${index}, '발표')" class="border border-blue-500 text-blue-500 hover:bg-blue-100 px-2 py-1 rounded-md text-xs">발표</button>
          <button onclick="addScore(${index}, '경청')" class="border border-green-500 text-green-500 hover:bg-green-100 px-2 py-1 rounded-md text-xs">경청</button>
          <button onclick="addScore(${index}, '지도')" class="border border-red-500 text-red-500 hover:bg-red-100 px-2 py-1 rounded-md text-xs">지도</button>
        </div>
      `;
    }

    function addScore(index, type) {
      const scores = currentPeriod === "전체" ? loadTotalScores() : loadScores();
      scores[index][type]++;
      if (currentPeriod !== "전체") saveScores(scores);
      renderStudents();
      popup.style.display = "none";
    }

    function renderStudents() {
      loadStudents();
      const scores = currentPeriod === "전체" ? loadTotalScores() : loadScores();
      studentGrid.innerHTML = "";
      students.forEach((name, index) => {
        const data = scores[index];
        const hasSpokenToday = ["1교시", "2교시", "3교시", "4교시", "5교시"].some(p => {
          const stored = JSON.parse(localStorage.getItem(getStorageKey(getTodayDate(), p)));
          return stored && stored[index].발표 > 0;
        });
        const baseClass = hasSpokenToday ? "border-blue-100" : "border-blue-300";
        const div = document.createElement("div");
        div.className = `rounded-2xl shadow-md p-3 flex flex-col items-center cursor-pointer border-2 transition-all text-sm ${baseClass}`;
        div.innerHTML = `
          <div class="font-semibold mb-1 text-center text-gray-800 text-[0.6rem] sm:text-xs truncate">${name}</div>
          <div class="flex gap-2 font-bold text-sm">
            <span class="text-blue-600">${data.발표}</span>
            <span class="text-green-600">${data.경청}</span>
            <span class="text-red-600">${data.지도}</span>
          </div>
        `;
        div.onclick = (e) => openPopup(index, e);
        div.setAttribute("draggable", true);
        div.addEventListener("dragstart", () => dragIndex = index);
        div.addEventListener("dragover", e => e.preventDefault());
        div.addEventListener("drop", () => {
          if (dragIndex !== null && dragIndex !== index) {
            [students[dragIndex], students[index]] = [students[index], students[dragIndex]];
            saveStudentOrderForToday();
            renderStudents();
            dragIndex = null;
          }
        });
        studentGrid.appendChild(div);
      });
    }

    const studentGrid = document.getElementById("studentGrid");
    const popup = document.getElementById("popup");
    const datePicker = document.getElementById("datePicker");

    document.querySelectorAll(".period-btn").forEach(btn => {
      btn.onclick = () => {
        currentPeriod = btn.dataset.period;
        document.querySelectorAll(".period-btn").forEach(b => b.classList.remove("bg-blue-500", "text-white"));
        document.querySelectorAll(".period-btn").forEach(b => b.classList.add("bg-white", "text-gray-700", "border"));
        btn.classList.remove("bg-white", "text-gray-700", "border");
        btn.classList.add("bg-blue-500", "text-white");
        renderStudents();
      };
    });

    window.onclick = (e) => {
      if (!popup.contains(e.target)) popup.style.display = "none";
    };

    document.getElementById("saveOrderBtn").addEventListener("click", () => {
      saveStudentOrderForToday();
      alert("자리 순서가 저장되었습니다.");
    });

    datePicker.addEventListener("change", renderStudents);
    datePicker.value = getTodayDate();
    renderStudents();
  </script>
</body>
</html>
